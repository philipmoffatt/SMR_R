---
title: "SMR-SAM Run Report"
---

``` {r, path_setup, echo = FALSE}

user <- Sys.info()[["user"]]
os <- Sys.info()[["sysname"]]

modeled_file_name <- paste0("MFC_mass_balance_", user, ".csv")
map_output_folder_name <- paste0("maps_", user)

if (os == "Linux") {
  r_path <- file.path("/home", user, "Dropbox", "SMR_R", "R")
  raw_data_path <- file.path("/home", user, "Dropbox", "SMR_R", "raw_data")
} else if (os == "Darwin") {
  r_path <- file.path("/Users", user, "Dropbox", "SMR_R", "R")
  raw_data_path <- file.path("/Users", user, "Dropbox", "SMR_R", "raw_data")
} else if (os == "Windows") {
  r_path <- file.path("C:", "Users", user, "Dropbox", "SMR_R", "R")
  raw_data_path <- file.path("C:", "Users", user, "Dropbox","SMR_R","raw_data")
}

post_processing_script_path <<- file.path(r_path,"scratch","functional_PP.R")
source_smr_function_path <<- file.path(r_path,"scratch","source_SMR_function.R")
perl_script_path <<-file.path(r_path,"scratch","smr_multiple_users.pl")

# pulling raw data paths in
validation_data_path <<- file.path(raw_data_path,"validation_data","mfc_cln_filled.csv")
mass_balance_path <<- file.path(raw_data_path,"smr_output" , modeled_file_name)
map_output_path <<- file.path(raw_data_path,'smr_output', map_output_folder_name)

```

```{r, function sourcing, echo = FALSE}
source(source_smr_function_path)
source(post_processing_script_path)
```

``` {r, running SMR, echo = FALSE, include = FALSE, eval = TRUE} 
run_SMR(params$location, params$mapset, params$perl_script_name,
        map_output_dir = map_output_path)
```


```{r, read_in_column_names, echo = FALSE}
column_headers <<- get_print_out_line(perl_script_path) 
```

## Run Identification:

```{r, version_tracking, echo = FALSE}
sim_note <<- params$simulation_note
version_tracked_outpath <<- version_tracker(mass_balance_path, simulation_note = sim_note)
```

|   Date of Model Run: `r params$date`
|   Modeled Period: `r params$run_start_date` to `r params$run_end_date`
|   Simulation Note: 
|       `r sim_note`
|       

```{r, processing_model_data, echo = FALSE}
VaM_data <<- preprocessing(
  validation_data_path,
  mass_balance_path,
  column_headers,
  version_tracked_outpath = version_tracked_outpath
)

```

## Model Performance Metrics:

The NSE for streamflow from this run is _____.
The KGE for streamflow from this run is _____.

## Report Outline:

|   1.0 Primary Graphed Results:
|       1.1 Modeled vs. Validation Stream Discharge
|       1.2 Mass Balance
|       1.3 Annual Accumulated Flux
|       1.4 Snow Melt and Accumulation Model Components
|       1.5 Radiation Fluxes

|   2.0 Map Outputs:
|       2.n Plots of any TIF files in the 'maps' folder from this run

|   3.0 Additional Graphs:
|       3.1 Snow Water Equivalent and its Components
|       3.2 Vapor Density of Air and Snow
|       3.3 Individual Flux Time Series


\newpage
1.1 Primary Graphed Results

```{r, Q comparison call, warning=FALSE, include=TRUE, echo=FALSE}
Q_comparison(VaM_data, log_transform = T)
```


\newpage
1.2 Mass Balance

```{r, mass balance, echo = FALSE}
mass_balance(VaM_data, log_transform = F)
```


\newpage
1.3 Annual Accumulated Fluxes

```{r, annual fluxes,echo = FALSE, include = TRUE, eval = TRUE}
flux_vector <<- c('runoff_cm', 'precip_cm', 'rain_cm', 
                 'actualET_flow_cm', 'canopy_evap_cm', 
                 'snowmelt_cm', 'storage_amt_cm', 
                 'throughfall_cm', 'canopy_storage_amt_cm', 
                 'perc_cm', 'swe_cm', 'condens_cm', 
                 'snow_cm', 'base_flow')
annual_fluxes(VaM_data, flux_vector, log_transform = F)
```


\newpage
1.4 Snow Melt and Accumulation Model Components

```{r, SAM check call, echo = FALSE}
SAM_check(VaM_data, log_transform = F)
```


\newpage
1.5 Radiation Fluxes

```{r, radiation time series, echo = FALSE}
radiation_ts(VaM_data, log_transform = F)
```


\newpage
2.n Maps

```{r, getting map outputs, echo = T, eval = TRUE }
version_tracked_map_dir <<- paste0(version_tracked_outpath, "/maps")
get_map_outputs(map_output_path, version_tracked_map_dir = version_tracked_map_dir)
```


\newpage
3.1 Components of the Snow Water Equivalent (SWE) Calculation

```{r, SWE components, echo = FALSE}
swe_debug(VaM_data, log_transform = F)
```


\newpage
3.2 Vapor Density Components of Q.Latent Calculation

```{r, q latent debugging, echo = FALSE}
q.latent_debug(VaM_data, log_transform = F)
```


\newpage
3.3 Individual Flux Time Series

```{r, individual flux timer series, echo = FALSE, warning = FALSE}
flux_ts_loop(
  combined_data = VaM_data, 
  fluxes = flux_vector, 
  log_transform = FALSE
  )
```

